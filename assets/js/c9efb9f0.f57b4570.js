"use strict";(self.webpackChunkblog_2023=self.webpackChunkblog_2023||[]).push([[6649],{3905:(e,n,t)=>{t.d(n,{Zo:()=>u,kt:()=>f});var r=t(7294);function o(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function s(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function l(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?s(Object(t),!0).forEach((function(n){o(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):s(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function i(e,n){if(null==e)return{};var t,r,o=function(e,n){if(null==e)return{};var t,r,o={},s=Object.keys(e);for(r=0;r<s.length;r++)t=s[r],n.indexOf(t)>=0||(o[t]=e[t]);return o}(e,n);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(r=0;r<s.length;r++)t=s[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(o[t]=e[t])}return o}var a=r.createContext({}),c=function(e){var n=r.useContext(a),t=n;return e&&(t="function"==typeof e?e(n):l(l({},n),e)),t},u=function(e){var n=c(e.components);return r.createElement(a.Provider,{value:n},e.children)},h="mdxType",p={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},m=r.forwardRef((function(e,n){var t=e.components,o=e.mdxType,s=e.originalType,a=e.parentName,u=i(e,["components","mdxType","originalType","parentName"]),h=c(t),m=o,f=h["".concat(a,".").concat(m)]||h[m]||p[m]||s;return t?r.createElement(f,l(l({ref:n},u),{},{components:t})):r.createElement(f,l({ref:n},u))}));function f(e,n){var t=arguments,o=n&&n.mdxType;if("string"==typeof e||o){var s=t.length,l=new Array(s);l[0]=m;var i={};for(var a in n)hasOwnProperty.call(n,a)&&(i[a]=n[a]);i.originalType=e,i[h]="string"==typeof e?e:o,l[1]=i;for(var c=2;c<s;c++)l[c]=t[c];return r.createElement.apply(null,l)}return r.createElement.apply(null,t)}m.displayName="MDXCreateElement"},3245:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>l,default:()=>p,frontMatter:()=>s,metadata:()=>i,toc:()=>c});var r=t(7462),o=(t(7294),t(3905));const s={title:"ES6\u5b66\u4e60\u2014Promise\u7684\u7b80\u5355\u5b9e\u73b0",date:new Date("2020-02-20T00:00:00.000Z"),slug:"promise-owner",tags:["Javascript","ES6"]},l=void 0,i={permalink:"/blog/promise-owner",source:"@site/blog/js/promise-owner.md",title:"ES6\u5b66\u4e60\u2014Promise\u7684\u7b80\u5355\u5b9e\u73b0",description:"\u8bb2\u5b8c promise \u7684\u4f7f\u7528\uff0c\u8fd9\u7bc7\u5b66\u4e60\u4e00\u4e0b\u600e\u4e48\u6765\u5b9e\u73b0\u4e00\u4e2a Promise\uff0c\u5565\u90fd\u4e0d\u8bf4\uff0c\u76f4\u63a5\u5f00\u5199\uff1a",date:"2020-02-20T00:00:00.000Z",formattedDate:"February 20, 2020",tags:[{label:"Javascript",permalink:"/blog/tags/javascript"},{label:"ES6",permalink:"/blog/tags/es-6"}],readingTime:6.64,hasTruncateMarker:!0,authors:[],frontMatter:{title:"ES6\u5b66\u4e60\u2014Promise\u7684\u7b80\u5355\u5b9e\u73b0",date:"2020-02-20T00:00:00.000Z",slug:"promise-owner",tags:["Javascript","ES6"]},prevItem:{title:"TypeScript\u57fa\u7840\u6570\u636e\u7c7b\u578b",permalink:"/blog/ts-basetype"},nextItem:{title:"ES6\u5b66\u4e60\u2014Promise\u7684\u4f7f\u7528",permalink:"/blog/promise-base"}},a={authorsImageUrls:[]},c=[{value:"Promise \u7684\u521d\u6b65\u5b9e\u73b0",id:"promise-\u7684\u521d\u6b65\u5b9e\u73b0",level:2},{value:"then \u65b9\u6cd5\u7684\u5b9e\u73b0",id:"then-\u65b9\u6cd5\u7684\u5b9e\u73b0",level:2},{value:"\u5f02\u6b65\u7684\u5b9e\u73b0",id:"\u5f02\u6b65\u7684\u5b9e\u73b0",level:2},{value:"Promise chain",id:"promise-chain",level:2},{value:"\u94fe\u5f0f\u8c03\u7528\u8fd4\u56de\u975e\u57fa\u672c\u7c7b\u578b\uff0c\u6bd4\u5982\u8fd4\u56de\u4e00\u4e2a promise",id:"\u94fe\u5f0f\u8c03\u7528\u8fd4\u56de\u975e\u57fa\u672c\u7c7b\u578b\u6bd4\u5982\u8fd4\u56de\u4e00\u4e2a-promise",level:2}],u={toc:c},h="wrapper";function p(e){let{components:n,...t}=e;return(0,o.kt)(h,(0,r.Z)({},u,t,{components:n,mdxType:"MDXLayout"}),(0,o.kt)("p",null,"\u8bb2\u5b8c promise \u7684\u4f7f\u7528\uff0c\u8fd9\u7bc7\u5b66\u4e60\u4e00\u4e0b\u600e\u4e48\u6765\u5b9e\u73b0\u4e00\u4e2a Promise\uff0c\u5565\u90fd\u4e0d\u8bf4\uff0c\u76f4\u63a5\u5f00\u5199\uff1a"),(0,o.kt)("p",null,"\u53c2\u8003\uff1a",(0,o.kt)("a",{parentName:"p",href:"http://malcolmyu.github.io/malnote/2015/06/12/Promises-A-Plus/"},"Promise A+ \u89c4\u8303"),"\u3001",(0,o.kt)("a",{parentName:"p",href:"https://www.bilibili.com/video/BV1L441157jg?p=8&spm_id_from=pageDriver"},"B\u7ad9\u6559\u5b66")),(0,o.kt)("h2",{id:"promise-\u7684\u521d\u6b65\u5b9e\u73b0"},"Promise \u7684\u521d\u6b65\u5b9e\u73b0"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"const PENDING = 'pending'\nconst FULFILLED = 'fulfilled'\nconst REJECTED = 'rejected'\nclass MyPromise {\n    constructor(executor) {\n        // \u53c2\u6570\u6821\u9a8c\n        if(typeof executor !== 'function') {\n            throw new Error(`Promise executor must be a function!`)\n        }\n        this.state = PENDING\n        this.value = null\n        this.reason = null\n        // \u7ed1\u5b9a this\n        executor(this.resolve.bind(this), this.reject.bind(this))\n    }\n    resolve(value) {\n        // \u5fc5\u987b\u662f PENGING \u72b6\u6001\u4e0b\uff0c\u624d\u6267\u884c\n        if(this.state === PENDING) {\n            this.state = FULFILLED\n            this.value = value\n        }\n    }\n    reject(reason) {\n        // \u5fc5\u987b\u662f PENGING \u72b6\u6001\u4e0b\uff0c\u624d\u6267\u884c\n        if(this.state === PENDING) {\n            this.state = REJECTED\n            this.reason = reason\n        }\n    }\n}\n\nconst p = new Promise((resolve, reject) => {\n    console.log('start')\n    resolve(2)\n}).then(value => {\n\n}, error => {\n\n})\n")),(0,o.kt)("h2",{id:"then-\u65b9\u6cd5\u7684\u5b9e\u73b0"},"then \u65b9\u6cd5\u7684\u5b9e\u73b0"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"const PENDING = 'pending'\nconst FULFILLED = 'fulfilled'\nconst REJECTED = 'rejected'\nclass MyPromise {\n    constructor(executor) {\n        // \u53c2\u6570\u6821\u9a8c\n        if(typeof executor !== 'function') {\n            throw new Error(`Promise executor must be a function!`)\n        }\n        this.state = PENDING\n        this.value = null\n        this.reason = null\n        executor(this.resolve.bind(this), this.reject.bind(this))\n    }\n    resolve(value) {\n        // \u5fc5\u987b\u662f PENGING \u72b6\u6001\u4e0b\uff0c\u624d\u6267\u884c\n        if(this.state === PENDING) {\n            this.state = FULFILLED\n            this.value = value\n        }\n    }\n    reject(reason) {\n        // \u5fc5\u987b\u662f PENGING \u72b6\u6001\u4e0b\uff0c\u624d\u6267\u884c\n        if(this.state === PENDING) {\n            this.state = REJECTED\n            this.reason = reason\n        }\n    }\n    then(onFulFilled, onRejected) {\n        // \u53c2\u6570\u5224\u65ad\uff08\u56e0\u4e3a\u4e24\u4e2a\u56de\u8c03\u90fd\u662f\u53ef\u9009\u7684\uff0c\u5982\u679c\u4e0d\u5b58\u5728\uff0c\u91cd\u65b0\u5305\u88c5\u4e00\u4e0b\uff0c\u4e3b\u8981\u5e94\u7528 then \u7a7f\u900f\u7684\u60c5\u51b5\uff09\n        // p.then().then(value => {})\n        if(typeof onFulFilled !== 'function') {\n            onFulFilled = () => this.value\n        }\n        if(typeof onRejected !== 'function') {\n            onRejected = () => this.reason\n        }\n        if(this.state === PENDING) {\n\n        }\n        if(this.state === FULFILLED) {\n            onFulFilled(this.value)\n        }\n        if(this.state === REJECTED) {\n            onRejected(this.reason)\n        }\n    }\n}\n\nconst p = new Promise((resolve, reject) => {\n    console.log('start')\n    reject(2)\n}).then(value => {\n    console.log(value, 'value');\n}, error => {\n    console.log(error, 'error');\n})\n")),(0,o.kt)("h2",{id:"\u5f02\u6b65\u7684\u5b9e\u73b0"},"\u5f02\u6b65\u7684\u5b9e\u73b0"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"const PENDING = 'pending'\nconst FULFILLED = 'fulfilled'\nconst REJECTED = 'rejected'\nclass MyPromise {\n    constructor(executor) {\n        // \u53c2\u6570\u6821\u9a8c\n        if(typeof executor !== 'function') {\n            throw new Error(`Promise executor must be a function!`)\n        }\n        this.state = PENDING\n        this.value = null\n        this.reason = null\n        this.onFulFilledCallbacks = [] // \u6210\u529f\u56de\u8c03\n        this.onRejectedCallbacks = [] // \u5931\u8d25\u56de\u8c03\n        // \u901a\u8fc7 try catch \u6355\u83b7 executor \u6267\u884c\u8fc7\u7a0b\u4e2d\u51fa\u7684\u9519\u8bef\uff0c\u901a\u8fc7 reject \u629b\u51fa\n        try {\n            executor(this.resolve.bind(this), this.reject.bind(this))\n        } catch (error) {\n            this.reject(error)\n        }\n    }\n    resolve(value) {\n        // \u5fc5\u987b\u662f PENGING \u72b6\u6001\u4e0b\uff0c\u624d\u6267\u884c\n        if(this.state === PENDING) {\n            this.state = FULFILLED\n            this.value = value\n            this.onFulFilledCallbacks.forEach(cb => cb(value))\n        }\n    }\n    reject(reason) {\n        // \u5fc5\u987b\u662f PENGING \u72b6\u6001\u4e0b\uff0c\u624d\u6267\u884c\n        if(this.state === PENDING) {\n            this.state = REJECTED\n            this.reason = reason\n            this.onRejectedCallbacks.forEach(cb => cb(reason))\n        }\n    }\n    then(onFulFilled, onRejected) {\n        // \u53c2\u6570\u5224\u65ad\uff08\u56e0\u4e3a\u4e24\u4e2a\u56de\u8c03\u90fd\u662f\u53ef\u9009\u7684\uff0c\u5982\u679c\u4e0d\u5b58\u5728\uff0c\u91cd\u65b0\u5305\u88c5\u4e00\u4e0b\uff0c\u4e3b\u8981\u5e94\u7528 then \u7a7f\u900f\u7684\u60c5\u51b5\uff09\n        // p.then().then(value => {})\n        if(typeof onFulFilled !== 'function') {\n            onFulFilled = () => this.value\n        }\n        if(typeof onRejected !== 'function') {\n            onRejected = () => this.reason\n        }\n        // const p = new MyPromise((resolve, reject) => {\n        //     setTimeout(() => {\n        //         resolve(2)\n        //     })\n        // })\n        if(this.state === PENDING) {\n            // \u5904\u7406\u5f02\u6b65 resolve() reject() \u7684\u60c5\u51b5\n            this.onFulFilledCallbacks.push(value => {\n                setTimeout(() => {\n                    onFulFilled(value)\n                })\n            })\n            this.onRejectedCallbacks.push(reason => {\n                setTimeout(() => {\n                    onRejected(reason)\n                })\n            })\n        }\n        if(this.state === FULFILLED) {\n            // setTimeout \u6a21\u62df Promise \u5f02\u6b65\u5904\u7406\n            setTimeout(() => {\n                onFulFilled(this.value)\n            })\n        }\n        if(this.state === REJECTED) {\n            // setTimeout \u6a21\u62df Promise \u5f02\u6b65\u5904\u7406\n            setTimeout(() => {\n                onRejected(this.reason)\n            })\n        }\n    }\n}\n\nconst p = new MyPromise((resolve, reject) => {\n    console.log(1)\n    setTimeout(() => {\n        reject(2)\n    })\n}).then(value => {\n    console.log(value, 'value');\n}, error => {\n    console.log(error, 'error');\n})\nconsole.log('sync log')\n")),(0,o.kt)("h2",{id:"promise-chain"},"Promise chain"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"const PENDING = 'pending'\nconst FULFILLED = 'fulfilled'\nconst REJECTED = 'rejected'\nclass MyPromise {\n    constructor(executor) {\n        // \u53c2\u6570\u6821\u9a8c\n        if(typeof executor !== 'function') {\n            throw new Error(`Promise executor must be a function!`)\n        }\n        this.state = PENDING\n        this.value = null\n        this.reason = null\n        this.onFulFilledCallbacks = [] // \u6210\u529f\u56de\u8c03\n        this.onRejectedCallbacks = [] // \u5931\u8d25\u56de\u8c03\n        // \u901a\u8fc7 try catch \u6355\u83b7 executor \u6267\u884c\u8fc7\u7a0b\u4e2d\u51fa\u7684\u9519\u8bef\uff0c\u901a\u8fc7 reject \u629b\u51fa\n        try {\n            executor(this.resolve.bind(this), this.reject.bind(this))\n        } catch (error) {\n            this.reject(error)\n        }\n    }\n    resolve(value) {\n        // \u5fc5\u987b\u662f PENGING \u72b6\u6001\u4e0b\uff0c\u624d\u6267\u884c\n        if(this.state === PENDING) {\n            this.state = FULFILLED\n            this.value = value\n            this.onFulFilledCallbacks.forEach(cb => cb(value))\n        }\n    }\n    reject(reason) {\n        // \u5fc5\u987b\u662f PENGING \u72b6\u6001\u4e0b\uff0c\u624d\u6267\u884c\n        if(this.state === PENDING) {\n            this.state = REJECTED\n            this.reason = reason\n            this.onRejectedCallbacks.forEach(cb => cb(reason))\n        }\n    }\n    then(onFulFilled, onRejected) {\n        // \u53c2\u6570\u5224\u65ad\uff08\u56e0\u4e3a\u4e24\u4e2a\u56de\u8c03\u90fd\u662f\u53ef\u9009\u7684\uff0c\u5982\u679c\u4e0d\u5b58\u5728\uff0c\u91cd\u65b0\u5305\u88c5\u4e00\u4e0b\uff0c\u4e3b\u8981\u5e94\u7528 then \u7a7f\u900f\u7684\u60c5\u51b5\uff09\n        // p.then().then(value => {})\n        if(typeof onFulFilled !== 'function') {\n            onFulFilled = () => this.value\n        }\n        if(typeof onRejected !== 'function') {\n            onRejected = () => this.reason\n        }\n\n        // \u7531\u4e8e Promise \u72b6\u6001\u4e0d\u53ef\u9006\uff0c\u6240\u4ee5\u8981\u5b9e\u73b0\u94fe\u5f0f\u8c03\u7528\uff0c\u5fc5\u987b\u8fd4\u56de\u4e00\u4e2a\u65b0\u7684 Promise \u5b9e\u4f8b\n        let promiseNext = new MyPromise((resolve, reject) => {\n            // const p = new MyPromise((resolve, reject) => {\n            //     setTimeout(() => {\n            //         resolve(2)\n            //     })\n            // })\n            if(this.state === PENDING) {\n                // \u5904\u7406\u5f02\u6b65 resolve() reject() \u7684\u60c5\u51b5\n                this.onFulFilledCallbacks.push(value => {\n                    setTimeout(() => {\n                        try {\n                            const result = onFulFilled(value)\n                            resolve(result)\n                        } catch (error) {\n                            reject(error)\n                        }\n                    })\n                })\n                this.onRejectedCallbacks.push(reason => {\n                    setTimeout(() => {\n                        try {\n                            const result = onRejected(reason)\n                            resolve(result)\n                        } catch (error) {\n                            reject(error)\n                        }\n                    })\n                })\n            }\n            if(this.state === FULFILLED) {\n                // setTimeout \u6a21\u62df Promise \u5f02\u6b65\u5904\u7406\n                setTimeout(() => {\n                    try {\n                        const result = onFulFilled(this.value)\n                        resolve(result)\n                    } catch (error) {\n                        reject(error)\n                    }\n                })\n            }\n            if(this.state === REJECTED) {\n                // setTimeout \u6a21\u62df Promise \u5f02\u6b65\u5904\u7406\n                setTimeout(() => {\n                    try {\n                        const result = onRejected(this.reason)\n                        resolve(result)\n                    } catch (error) {\n                        reject(error)\n                    }\n                })\n            }\n        })\n\n        return promiseNext\n    }\n}\n\nconst p = new MyPromise((resolve, reject) => {\n    console.log(1)\n    resolve(2)\n}).then(value => {\n    console.log(value, 'value');\n    return value\n}, error => {\n    console.log(error, 'error');\n}).then(value => {\n    console.log('value promise2', value)\n})\nconsole.log('sync log')\n")),(0,o.kt)("h2",{id:"\u94fe\u5f0f\u8c03\u7528\u8fd4\u56de\u975e\u57fa\u672c\u7c7b\u578b\u6bd4\u5982\u8fd4\u56de\u4e00\u4e2a-promise"},"\u94fe\u5f0f\u8c03\u7528\u8fd4\u56de\u975e\u57fa\u672c\u7c7b\u578b\uff0c\u6bd4\u5982\u8fd4\u56de\u4e00\u4e2a promise"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"MyPromise.resolvePromise = function (promise2, x, resolve, reject) {\n    // x \u4e0e promise \u76f8\u7b49\n    if (promise2 === x) {\n        reject(new TypeError('Chaining cycle detected for promise'))\n    }\n\n    let called = false\n    if (x instanceof MyPromise) {\n        // \u5224\u65ad x \u4e3a Promise\n        x.then(\n            value => {\n                MyPromise.resolvePromise(promise2, value, resolve, reject)\n            },\n            reason => {\n                reject(reason)\n            }\n        )\n    } else if (x !== null && (typeof x === 'object' || typeof x === 'function')) {\n        // x \u4e3a\u5bf9\u8c61\u6216\u51fd\u6570\n        try {\n            const then = x.then\n            if (typeof then === 'function') {\n                then.call(\n                    x,\n                    value => {\n                        if (called) return\n                        called = true\n                        MyPromise.resolvePromise(promise2, value, resolve, reject)\n                    },\n                    reason => {\n                        if (called) return\n                        called = true\n                        reject(reason)\n                    }\n                )\n            } else {\n                if (called) return\n                called = true\n                resolve(x)\n            }\n        } catch (e) {\n            if (called) return\n            called = true\n            reject(e)\n        }\n    } else {\n        resolve(x)\n    }\n}\n")))}p.isMDXComponent=!0}}]);